<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-1,BlueNRG-2 network coprocessor: Framework description</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-1,BlueNRG-2 network coprocessor
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Framework description </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes the BlueNRG-1, BlueNRG2 network coprocessor framework and implementation on a STM32L4xx microcontroller (NUCLEO-L476RG platform).<br />
 The document content is valid for BlueNRG-1,BlueNRG2 devices.<br />
</p>
<h1><a class="anchor" id="U1"></a>
Introduction</h1>
<ul>
<li><a href="www.st.com/bluenrg-1">BlueNRG-1 </a> and <a href="www.st.com/bluenrg-2">BlueNRG-2 </a>Bluetooth Low Energy (BLE) System on Chips devices can be also configured as Bluetooth Low Energy (BLE) network coprocessor combining both BLE host and controller solutions. </li>
<li>An application command interface (ACI) is provided for accessing the BlueNRG-1, BlueNRG-2 BLE network coprocessor host and controller: <ul>
<li>
User applications, i.e. programs running in another silicon chip, can send ACI commands to control the BlueNRG-1, BlueNRG-2 BLE network coprocessor. </li>
<li>
SPI or UART interface can be used to connect an external device, where the application runs, which sends ACI commands to control BlueNRG-1/BlueNRG-2 device and receives events from it. The ACI commands and events are transmitted through the selected bus interface (SPI or UART). </li>
</ul>
</li>
</ul>
<ul>
<li>As reference example for a external device connecting to the BlueNRG-1, BlueNRG-2 devices configured as BLE network coprocessors, the NUCLEO-L476RG with STM32L4 microcontroller has been used.</li>
</ul>
<h1><a class="anchor" id="U2"></a>
SPI network coprocessor framework</h1>
<ul>
<li>The BlueNRG-1, BlueNRG-2 SPI communication protocol is described on <a href="../SPI_protocol_specification/SPI_protocol_specification.html">SPI protocol specification </a> html documentation. </li>
<li>The NUCLEO-L476RG - BlueNRG-1, BlueNRG-2 hardware SPI interface and requested connections, BlueNRG-1, BlueNRG-2 SW Configuration description, STM32Lx Network coprocessor framework structure and demonstration applications are described on the associated <a href="../STM32_SPI_protocol_example_html/STM32_SPI_protocol_example.html">NUCLEO-L476RG - STEVAL-IDB007Vx, STEVAL-IDB008Vx, STEVAL-IDB009Vx SPI network coprocessor </a> html documentation. </li>
<li>This documents also describes the typical STM32Lx - Network coprocessor application structure, taking as reference the STM32L BLE Sensor demonstration application, in terms of: <ul>
<li>
Project structure </li>
<li>
Main function structure: <ul>
<li>
Init_Device(): it initializes the STM32L4 device (HAL, clock, ...) and the UART interface for BlueNRG-1,2 network coprocessor. </li>
<li>
BlueNRG_Stack_Initialization(): it initializes the ACI framework lists and it resets the BlueNRG-1,2 device </li>
<li>
Sensor_DeviceInit(): it calls the BlueNRG-1,2 APIs for configuring the BLE stack (set public address, init GATT and GAP layers, set TX power level, set security settings, add the specific Sensor Demo services and chracteristics, init user timers required for the Sensor Demo application. </li>
<li>
BTLE_StackTick(): BLE stack tick APIs which allows to process the BLE stack events coming from BlueNRG-1,2 BLE stack. </li>
<li>
APP_Tick(): application tick function which implements the application specific state machine. </li>
<li>
System_Sleep(): low power managment API. </li>
</ul>
</li>
<li>
BLE stack events callbacks example </li>
</ul>
</li>
</ul>
<ul>
<li><b> NOTE </b>: User can take as reference the provided demonstrations applications (SPI framework), in order to implements its own demo application interacting with the BlueNRG-1, BlueNRG-2 device configured as BLE network coprocessor (SPI mode).</li>
</ul>
<h1><a class="anchor" id="U3"></a>
UART network coprocessor framework</h1>
<ul>
<li>The UART supported configurations (with or without HW flow control), NUCLEO-L476RG - BlueNRG-1, BlueNRG-2 hardware UART interface and requested connections, BlueNRG-1, BlueNRG-2 SW Configuration description, STM32L4xx Network coprocessor framework structure and demonstration applications are described on the associated <a href="../STM32_UART_protocol_example_html/STM32_UART_protocol_example.html">NUCLEO-L476RG - STEVAL-IDB007Vx, STEVAL-IDB008Vx, STEVAL-IDB009Vx URT network coprocessor </a> html documentation. </li>
<li>This documents also describes the typical STM32L4 - Network coprocessor application structure, taking as reference the STM32L BLE Sensor demonstration application, in terms of: <ul>
<li>
Project structure </li>
<li>
Main function structure: <ul>
<li>
Init_Device(): it initializes the STM32L4 device (HAL, clock, ...) and the UART interface for BlueNRG-1,2 network coprocessor. </li>
<li>
BlueNRG_Stack_Initialization(): it initializes the ACI framework lists and it reset the BlueNRG-1,2 device </li>
<li>
Sensor_DeviceInit(): it calls the BlueNRG-1,2 APIs for configuring the BLE stack (set public address, init GATT and GAP layers, set TX power level, set security settings, add the specific Sensor Demo services and chracteristics, init user timers required for the Sensor Demo application. </li>
<li>
BTLE_StackTick(): BLE stack tick APIs which allows to process the BLE stack events coming from BlueNRG-1,2 BLE stack. </li>
<li>
APP_Tick(): application tick function which implements the application specific state machine. </li>
<li>
System_Sleep(): low power managment API. </li>
</ul>
</li>
<li>
BLE stack events callbacks example </li>
</ul>
</li>
</ul>
<ul>
<li><b> NOTE </b>: User can take as reference the provided demonstrations applications (UART framework), in order to implements its own demo application interacting with the BlueNRG-1, BlueNRG-2 device configured as BLE network coprocessor (UART mode).</li>
</ul>
<h1><a class="anchor" id="U4"></a>
Network coprocessor ACIs, Events and Constants definition</h1>
<ul>
<li>The <a href="../STM32_APIs_Events_html/files.html">STM32L - BlueNRG-1,2 BLE stack APIs, Events and Constants</a> provides the list of ACI interface files (APIs, events, constants, errors) and related description: <ul>
<li>
ble_status.h: Header file which contains definition of Bluetooth status and error codes </li>
<li>
bluenrg1_events.h: Header file for external uC - BlueNRG-x in network coprocessor mode (Event callbacks) </li>
<li>
bluenrg1_gap.h: Header file for BlueNRG-1's GAP layer constants </li>
<li>
bluenrg1_gap_aci.h: Header file for external uC - BlueNRG-x in network coprocessor mode (gap_aci) </li>
<li>
bluenrg1_gatt_aci.h: Header file for external uC - BlueNRG-x in network coprocessor mode (gatt_aci) </li>
<li>
bluenrg1_gatt_server.h: Header file for BlueNRG-1's GATT server layer constants </li>
<li>
bluenrg1_hal.h Header: file with HAL define for BlueNRG-1 </li>
<li>
bluenrg1_hal_aci.h: Header file for external uC - BlueNRG-x in network coprocessor mode (hal_aci) </li>
<li>
bluenrg1_hci_le.h: Header file for external uC - BlueNRG-x in network coprocessor mode (hci_le) </li>
<li>
bluenrg1_l2cap_aci.h: Header file for external uC - BlueNRG-x in network coprocessor mode (l2cap_aci) </li>
<li>
hci.h: Header file for BlueNRG-1's HCI APIs </li>
<li>
link_layer.h: Header file for BlueNRG-1's link layer constants </li>
<li>
sm.h: Header file for BlueNRG-1's security manager constants </li>
</ul>
</li>
</ul>
<ul>
<li>These files are provided inside {Project folder}\Library\STM32L\Middlewares\ST\STM32_BlueNRG1\SimpleBlueNRG1_HCI\includes folder.</li>
</ul>
<h1><a class="anchor" id="U5"></a>
BlueNRG-MS vs BlueNRG-1, BlueNRG-2 network coprocessor</h1>
<ul>
<li>The <a href="www.st.com/bluenrg-ms">BlueNRG-MS </a> Bluetooth Low Energy is a network coprocessor device which provides <b>only a SPI interface</b>. </li>
<li>It can be used to connect an external device, where the application runs, which sends ACI commands to control BlueNRG-MS and receives events from it. The ACI commands and events are transmitted through the SPI bus. </li>
<li>No UART interface is provided by BlueNRG-MS device.</li>
</ul>
<ul>
<li>BlueNRG-MS and BlueNRG-1, BlueNRG-2 SPI IPs are different: <ul>
<li>
BlueNRG-MS SPI slave can support up to 8MHz. </li>
<li>
BlueNRG-1, BlueNRG-2 maximal supported SPI baud rate is 1 MHz in slave mode. </li>
<li>
<b> NOTE </b>BlueNRG-2, BLE stack v2.1 or later supports BLE data length extension feature. This feature could be used for increasing the number of data in a single LL packet and, as consequence, on a single SPI transaction.</li>
</ul>
</li>
</ul>
<ul>
<li>BlueNRG-MS and BlueNRG-1, BlueNRG-2 SPI protocols implementation are also different. </li>
<li>The following table describes the overall SPI network coprocessor framework folders structure on BlueNRG-MS (STSW-BLUENRG-DK) and BlueNRG-1,2 (STSW-BLUENRG1-DK) SDKs:</li>
</ul>
<table  border="1">
<tr>
<th></th><th>BlueNRG-MS DK SW package (STSW-BLUENRG-DK) </th><th>BlueNRG-1_2 SW package (STSW-BLUENRG1-DK) </th><th>Description  </th></tr>
<tr>
<td><b> Nucleo-Lxxxx SDK Drivers </b> </td><td>Projects\Drivers\BSP\STM32L1xx_Nucleo &amp; STM32L1xx_STEVAL_IDB00xV1 </td><td>Library\STM32L\Drivers\BSP\STM32Lxx_Nucleo </td><td>SDK Drivers for NUCLEO-L476RG Leds, COM, timers </td></tr>
<tr>
<td><b> STM32Lx Nucleo - BlueNRG-1,2 </b> </td><td>Projects\Drivers\BSP\STM32L1xx_BlueNRG </td><td>Library\STM32L\Drivers\BSP\STM32Lxx_BlueNRG1 </td><td>NUCLEO-L476RG SDK SPI driver for interfacing to BlueNRG-1,2 network coprocessor  </td></tr>
<tr>
<td><b> STM32Lx CMSIS </b> </td><td>Projects\Drivers\CMSIS </td><td>Library\STM32L\Drivers\CMSIS </td><td>CMSIS files for STM32Lx  </td></tr>
<tr>
<td><b> STM32Lx Cube HAL drivers </b> </td><td>Projects\Drivers\STM32L1xx_HAL_Driver </td><td>Library\STM32L\Drivers\STM32L4xx_HAL_Driver </td><td>STM32Lx HAL drivers (Cube framework) </td></tr>
<tr>
<td><b> HAL drivers </b> </td><td>Not Applicable </td><td>Library\STM32L\Drivers\Middlewares\ST\STM32_BlueNRG1\HAL </td><td>HAL drivers (osal, low power, timers) </td></tr>
<tr>
<td><b> SPI HAL drivers </b> </td><td>Projects\Middlewares\ST\STM32_BlueNRG\STM32L1xx_HAL_BlueNRG_Drivers </td><td>Library\STM32L\Drivers\Middlewares\ST\STM32L4xx_HAL_BlueNRG1_Drivers </td><td>SPI middlewares utilities </td></tr>
<tr>
<td><b> ACI framework protocol (SPI mode) </b> </td><td>Projects\Middlewares\ST\STM32_BlueNRG\SimpleBlueNRG_HCI </td><td>Library\STM32L\Middlewares\ST\STM32_BlueNRG1\SimpleBlueNRG1_HCI </td><td>BLE stack ACI framework APIs for interfacing to the BlueNRG-1,2 BLE stack features and events </td></tr>
<tr>
<td><b> BLE Demonstration application </b> </td><td>Projects\Projects_Cube\BLE_Beacon </td><td>Project\STM32L\BLE_Beacon_NWK </td><td>BLE Beacon demo application </td></tr>
<tr>
<td><b> BLE Demonstration application </b> </td><td>Projects\Projects_Cube\BlueNRG-MS_New_Chat </td><td>Project\STM32L\BLE_ChatMasterSlave_NWK </td><td>BLE Chat Master/Slave demo application </td></tr>
<tr>
<td><b> BLE Demonstration application </b></td><td>Projects\Projects_Cube\SensorDemo_New </td><td>Project\STM32L\BLE_SensorDemo_NWK </td><td>BLE Sensor demo application </td></tr>
<tr>
<td><b> BLE stack, IFR updater </b></td><td>Projects\Projects_Cube\BlueNRG_Stack_IFR_Updater </td><td>Project\STM32L\BlueNRG_Stack_IFR_Updater </td><td>BLE stack, IFR updater demo application </td></tr>
<tr>
<td><b> BLE Test application </b> </td><td>Projects\Projects_Cube\Virtual_COM_Port </td><td>Project\STM32L\DTM_NWK </td><td>BLE Direct Test Mode application  </td></tr>
</table>
<ul>
<li>When moving an application from BlueNRG-MS context to STM32L4 - BlueNRG-1,2 SPI user should follow these steps:<ul>
<li>
Create a new application folder in {Project folder}\Project\STM32L: user can simply copy and paste one of the available demonstration application folder (BLE_Beacon, BLE_ChatMasterSlave, BLE_SensorDemo): <ul>
<li>
Rename applications projects and files inline with selected user application naming. STM32L, BlueNRG-1,2 BLE_SensorDemo demo application is taken as reference: <ul>
<li>
BLE_SensorDemo_main.c &ndash;&gt; to be renamed according to user application name (i.e.: BLE_User_main.c); </li>
<li>
sensor.[ch] &ndash;&gt; to be renamed according to user application name (i.e: user.[ch]). </li>
<li>
BLE_SensorDemo.[eww, wep, ewd] to be rennamed and customized according to user application name (BLE_UserDemo.[eww, wep, ewd]): <ul>
<li>
Edit file BLE_UserDemo.eww for referring BLE_UserDemo.ewp; </li>
<li>
Edit file BLE_UserDemo.ewp for referring the user selected files names: BLE_User_main.c, user.c files </li>
</ul>
</li>
</ul>
</li>
<li>
Open the associated IAR project (refer to <a href="../STM32_SPI_protocol_example_html/STM32_SPI_protocol_example.html">NUCLEO-L476RG - STEVAL-IDB007Vx, STEVAL-IDB008Vx, STEVAL-IDB009Vx SPI network coprocessor </a> html documentation, Figure 1: BLE Sensor Demo, Release_SPI configuration example): <ul>
<li>
If needed, further customize BLE_User_main.c file, keeping the STM32L - BlueNRG-1,2 initialization sequence and while() loop code provided on STM32L references demonstrations applications (refer to <a href="../STM32_SPI_protocol_example_html/STM32_SPI_protocol_example.html">NUCLEO-L476RG - STEVAL-IDB007Vx, STEVAL-IDB008Vx, STEVAL-IDB009Vx SPI network coprocessor </a> html documentation, Figure 2: BLE Sensor Demo, main() Function). </li>
<li>
On user.c file: <ul>
<li>
App_Tick() function: it should contain BlueNRG-MS application state machine code; </li>
<li>
Move here any other user specific application code. </li>
<li>
Refer to <a href="../STM32_SPI_protocol_example_html/STM32_SPI_protocol_example.html">NUCLEO-L476RG - STEVAL-IDB007Vx, STEVAL-IDB008Vx, STEVAL-IDB009Vx SPI network coprocessor </a> html documentation, Figure 3: BLE Sensor Demo, APP_Tick() function.</li>
</ul>
</li>
<li>
gatt_db.c file: it should include user application services definition, characteristic definition and characteristics operations; </li>
<li>
Align Bluetooth Low Energy ACI commands and related parameters from BlueNRG-MS FW 7.x to BlueNRG-1,2 BlueNRG-BLE Stack Library v2.1 or later. </li>
<li>
Customize events management by moving each specific user event code provided on BlueNRG-MS, HCI_Event_CB() function on related BlueNRG-1,2 event callaback (refer to <a href="../STM32_SPI_protocol_example_html/STM32_SPI_protocol_example.html">NUCLEO-L476RG - STEVAL-IDB007Vx, STEVAL-IDB008Vx, STEVAL-IDB009Vx SPI network coprocessor </a> html documentation, Figure 4: BLE Sensor Demo, hci_le_connection_complete_event() callback). </li>
<li>
stm32xx_it.c: to be customized based on specific requested application irq handlers; </li>
<li>
Keep all the other BlueNRG-1,2 STM32L network coprocessor files available on copied application folder. </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2021 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
